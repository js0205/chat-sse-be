#!/bin/bash

# éƒ¨ç½²è„šæœ¬
echo "ğŸš€ å¼€å§‹éƒ¨ç½² chat-sse-be æœåŠ¡..."

# 1. æ£€æŸ¥ç¯å¢ƒ
echo "ğŸ“‹ æ£€æŸ¥ç¯å¢ƒ..."
if ! command -v node &> /dev/null; then
    echo "âŒ Node.js æœªå®‰è£…"
    exit 1
fi

if ! command -v pnpm &> /dev/null; then
    echo "âŒ pnpm æœªå®‰è£…"
    exit 1
fi

# 2. å®‰è£…ä¾èµ–
echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
pnpm install --frozen-lockfile

# 3. æ„å»ºé¡¹ç›®
echo "ğŸ”¨ æ„å»ºé¡¹ç›®..."
pnpm run build

# 4. æ£€æŸ¥æ„å»ºç»“æœ
if [ ! -f "dist/index.js" ]; then
    echo "âŒ æ„å»ºå¤±è´¥"
    exit 1
fi

# 5. å®‰è£…PM2ï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
if ! command -v pm2 &> /dev/null; then
    echo "ğŸ“¦ å®‰è£… PM2..."
    npm install -g pm2
fi

# 6. åœæ­¢æ—§æœåŠ¡
echo "ğŸ›‘ åœæ­¢æ—§æœåŠ¡..."
pm2 stop chat-sse-be 2>/dev/null || true

# 7. å¯åŠ¨æœåŠ¡
echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
pm2 start ecosystem.config.js --env production

# 8. ä¿å­˜PM2é…ç½®
pm2 save

# 9. è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup

echo "âœ… éƒ¨ç½²å®Œæˆï¼"
echo "ğŸ“Š æŸ¥çœ‹çŠ¶æ€: pm2 status"
echo "ğŸ“‹ æŸ¥çœ‹æ—¥å¿—: pm2 logs chat-sse-be" 